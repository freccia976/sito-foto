<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Pagina privata</title>

<style>

/* ===== RESET ===== */

*{
  box-sizing:border-box;
  font-family:Arial,sans-serif;
}

body{
  margin:0;
  background:#0f1220;
  color:#eaeaf0;
}

/* ===== HEADER ===== */

header{
  background:#15182d;
  padding:20px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #23264a;
  position:sticky;
  top:0;
  z-index:1000;
}

.header-right{
  display:flex;
  gap:10px;
  align-items:center;
}

header button{
  background:#667eea;
  border:none;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

.admin-tools{display:none;}

/* ===== LAYOUT ===== */

.layout{
  padding:20px 40px;
}

/* ===== GALLERY GRID ===== */

.gallery{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:14px;
}

@media(max-width:1400px){
.gallery{grid-template-columns:repeat(5,1fr);}
}
@media(max-width:1100px){
.gallery{grid-template-columns:repeat(4,1fr);}
}
@media(max-width:800px){
.gallery{grid-template-columns:repeat(3,1fr);}
}
@media(max-width:500px){
.gallery{grid-template-columns:repeat(2,1fr);}
}

.photo{
  border-radius:10px;
  overflow:hidden;
  aspect-ratio:1/1;
}

.photo img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

/* ===== FULL VIEW ===== */

.gallery.full{
  grid-template-columns:1fr;
  justify-items:center;
  gap:30px;
}

.gallery.full .photo{
  width:90%;
  max-width:1200px;
  height:80vh;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
}

.gallery.full img{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* ===== LOGIN ===== */

.login{
  max-width:400px;
  margin:120px auto;
  background:#15182d;
  padding:40px;
  border-radius:12px;
  text-align:center;
}

.login input{
  width:100%;
  padding:12px;
  margin-bottom:20px;
  border:none;
  border-radius:6px;
}

.login button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:6px;
  background:#667eea;
  color:white;
}

/* ===== DRAG OVERLAY ===== */

.drag-overlay{
  position:fixed;
  inset:0;
  background:rgba(102,126,234,0.05);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
  z-index:9999;
}

</style>
</head>
<body>

<header>

<h1>üì∏ Pagina privata</h1>

<div class="header-right">

<button onclick="setGrid()">üß±</button>
<button onclick="setFull()">üñºÔ∏è</button>

<div class="admin-tools" id="adminTools">
<button onclick="fileInput.click()">‚ûï</button>
<button onclick="deletePage()" style="background:#e53e3e;">üóë</button>
</div>

</div>
</header>

<div class="login" id="loginBox">
<h2>Accesso riservato</h2>
<input type="password" id="pwd">
<button onclick="checkPassword()">Entra</button>
</div>

<div class="layout" id="content" style="display:none;">
<div class="gallery" id="gallery"></div>
</div>

<input type="file" id="fileInput" multiple hidden>

<script type="module">

// ===== FIREBASE =====
import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,doc,getDoc,collection,addDoc,
onSnapshot,query,orderBy,deleteDoc,getDocs
} from
"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app=initializeApp({
apiKey:"AIzaSy...",
authDomain:"sito-foto-98234.firebaseapp.com",
projectId:"sito-foto-98234"
});

const db=getFirestore(app);

// ===== ELEMENTI =====
const gallery=document.getElementById("gallery");
const loginBox=document.getElementById("loginBox");
const content=document.getElementById("content");
const adminTools=document.getElementById("adminTools");
const fileInput=document.getElementById("fileInput");

const isAdmin=localStorage.getItem("admin")==="true";

// ===== VIEW MODE =====
window.setGrid=()=>{
gallery.classList.remove("full");
localStorage.setItem("viewMode","grid");
loadPhotosRealtime();
};

window.setFull=()=>{
gallery.classList.add("full");
localStorage.setItem("viewMode","full");
loadPhotosRealtime();
};

if(localStorage.getItem("viewMode")==="full"){
gallery.classList.add("full");
}

// ===== LOGIN =====
window.checkPassword=async()=>{

const pwd=document.getElementById("pwd").value;
const snap=await getDoc(doc(db,"page","config"));

if(!snap.exists()) return alert("Pagina non attiva");

if(pwd===snap.data().password){
localStorage.setItem("userAccess","true");
enterPage();
}else{
alert("Password errata");
}
};

// ===== ENTER =====
async function enterPage(){

const snap=await getDoc(doc(db,"page","config"));

if(!snap.exists()){
if(isAdmin) location.href="admin.html";
else showDeleted();
return;
}

loginBox.style.display="none";
content.style.display="block";
loadPhotosRealtime();
}

if(isAdmin){
adminTools.style.display="block";
enterPage();
}

if(localStorage.getItem("userAccess")==="true"){
enterPage();
}

// ===== UPLOAD =====
fileInput.addEventListener("change",uploadFiles);

async function uploadFiles(files=fileInput.files){

for(let file of files){

const fd=new FormData();
fd.append("file",file);
fd.append("upload_preset","sito-foto");

const res=await fetch(
"https://api.cloudinary.com/v1_1/dwamsmg53/image/upload",
{method:"POST",body:fd}
);

const data=await res.json();

await addDoc(collection(db,"photos"),{
url:data.secure_url,
created:Date.now()
});
}
}

// ===== GALLERY =====
function loadPhotosRealtime(){

const q=query(
collection(db,"photos"),
orderBy("created","desc")
);

onSnapshot(q,snap=>{

gallery.innerHTML="";

snap.forEach(d=>{

const original=d.data().url;

const gridUrl=original.replace(
"/upload/",
"/upload/c_fill,w_500,h_500,q_auto,f_auto/l_text:Arial_80:¬©%20Privato,o_20,a_45,g_center/"
);

const fullUrl=original.replace(
"/upload/",
"/upload/c_limit,w_1600,h_1600,q_auto:best,f_auto/l_text:Arial_80:¬©%20Privato,o_20,a_45,g_center/"
);

const img=gallery.classList.contains("full")?fullUrl:gridUrl;

gallery.innerHTML+=`
<div class="photo">
<img src="${img}" oncontextmenu="return false">
</div>`;
});
});
}

// ===== DELETE PAGE =====
window.deletePage=async()=>{

if(!confirm("Eliminare pagina?")) return;

await deleteDoc(doc(db,"page","config"));

const photos=await getDocs(collection(db,"photos"));
photos.forEach(p=>deleteDoc(p.ref));

const msgs=await getDocs(collection(db,"messages"));
msgs.forEach(m=>deleteDoc(m.ref));

localStorage.clear();

if(isAdmin) location.href="admin.html";
else showDeleted();
};

function showDeleted(){
document.body.innerHTML=`
<div style="
height:100vh;
display:flex;
justify-content:center;
align-items:center;
flex-direction:column;">
<h1>üì∏ Pagina eliminata</h1>
</div>`;
}

// ===== DRAG PAGE =====
if(isAdmin){

let overlay=null;

document.addEventListener("dragenter",e=>{
e.preventDefault();
if(!overlay){
overlay=document.createElement("div");
overlay.className="drag-overlay";
overlay.innerText="Rilascia le foto";
document.body.appendChild(overlay);
}
});

document.addEventListener("drop",e=>{
e.preventDefault();
overlay?.remove();
uploadFiles(e.dataTransfer.files);
});
}

</script>
</body>
</html>
