<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Pagina privata</title>

<style>

*{
  box-sizing:border-box;
  font-family:Arial,sans-serif;
}

body{
  margin:0;
  background:#0f1220;
  color:#eaeaf0;
}

/* ===== HEADER ===== */

header{
  background:#15182d;
  padding:20px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #23264a;
  position:sticky;
  top:0;
  z-index:1000;
}

.header-right{
  display:flex;
  gap:10px;
  align-items:center;
}

header button{
  background:#667eea;
  border:none;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

.admin-tools{display:none;}

/* ===== LAYOUT ===== */

.layout{
  display:grid;
  grid-template-columns:1fr;
  padding:20px 40px;
}

/* ===== GALLERY GRID ===== */

.gallery{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:14px;
}

@media (max-width:1400px){
.gallery{grid-template-columns:repeat(5,1fr);}
}
@media (max-width:1100px){
.gallery{grid-template-columns:repeat(4,1fr);}
}
@media (max-width:800px){
.gallery{grid-template-columns:repeat(3,1fr);}
}
@media (max-width:500px){
.gallery{grid-template-columns:repeat(2,1fr);}
}

.photo{
  background:transparent;
  border-radius:10px;
  overflow:hidden;
  aspect-ratio:1/1;
}

.photo img{
  width:100%;
  height:100%;
  object-fit:contain;
  background:#000;
}

/* ===== FULL VIEW ===== */

.gallery.full{
  grid-template-columns:1fr;
  justify-items:center;
  gap:30px;
}

.gallery.full .photo{
  width:90%;
  max-width:1200px;
  height:80vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
  border-radius:12px;
}

.gallery.full img{
  width:100%;
  height:100%;
  object-fit:contain;
}

/* ===== LOGIN ===== */

.login{
  max-width:400px;
  margin:120px auto;
  background:#15182d;
  padding:40px;
  border-radius:12px;
  text-align:center;
}

.login input{
  width:100%;
  padding:12px;
  margin-bottom:20px;
  border:none;
  border-radius:6px;
}

.login button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:6px;
  background:#667eea;
  color:white;
}

/* ===== CHAT ===== */

.chat{
  position:fixed;
  right:0;
  width:300px;
  background:#15182d;
  border-left:1px solid #23264a;
  display:flex;
  flex-direction:column;
}

.chat input{
  width:100%;
  padding:10px;
  border:none;
  border-radius:6px;
}

.messages{
  flex:1;
  overflow-y:auto;
  padding:15px;
}

/* ===== DRAG OVERLAY ===== */

.drag-overlay{
  position:fixed;
  inset:0;
  background:rgba(102,126,234,0.05);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
  color:white;
  z-index:9999;
}

</style>
</head>
<body>

<header>

<h1>üì∏ Pagina privata</h1>

<div class="header-right">

<button onclick="setGrid()">üß±</button>
<button onclick="setFull()">üñºÔ∏è</button>

<div class="admin-tools" id="adminTools">
<button onclick="fileInput.click()">‚ûï Carica foto</button>
<button onclick="deletePage()" style="background:#e53e3e;">üóë Elimina pagina</button>
</div>

</div>
</header>

<div class="login" id="loginBox">
<h2>Accesso riservato</h2>
<input type="password" id="pwd">
<button onclick="checkPassword()">Entra</button>
</div>

<div class="layout" id="content" style="display:none;">
<div class="gallery" id="gallery"></div>
</div>

<input type="file" id="fileInput" multiple hidden>

<script type="module">

// ===== FIREBASE =====
import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,doc,getDoc,collection,addDoc,
onSnapshot,query,orderBy,deleteDoc,getDocs
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app=initializeApp({
apiKey:"AIzaSyBcexeHnAQ-ee5q5ZUT_7SqaMS-aSWZdcY",
authDomain:"sito-foto-98234.firebaseapp.com",
projectId:"sito-foto-98234"
});

const db=getFirestore(app);

// ===== ELEMENTI =====
const gallery=document.getElementById("gallery");
const loginBox=document.getElementById("loginBox");
const content=document.getElementById("content");
const adminTools=document.getElementById("adminTools");
const fileInput=document.getElementById("fileInput");

const isAdmin=localStorage.getItem("admin")==="true";

// ===== VIEW =====
window.setGrid=()=>{
gallery.classList.remove("full");
localStorage.setItem("viewMode","grid");
loadPhotosRealtime();
};

window.setFull=()=>{
gallery.classList.add("full");
localStorage.setItem("viewMode","full");
loadPhotosRealtime();
};

if(localStorage.getItem("viewMode")==="full"){
gallery.classList.add("full");
}

// ===== LOGIN =====
window.checkPassword=async()=>{

const pwd=document.getElementById("pwd").value;
const snap=await getDoc(doc(db,"page","config"));

if(!snap.exists()) return alert("Pagina non attiva");

if(pwd===snap.data().password){
localStorage.setItem("userAccess","true");
enterPage();
}else{
alert("Password errata");
}
};

// ===== ENTER =====
async function enterPage(){

const snap=await getDoc(doc(db,"page","config"));
if(!snap.exists()) return showDeleted();

loginBox.style.display="none";
content.style.display="grid";
loadPhotosRealtime();
}

if(isAdmin){
adminTools.style.display="block";
enterPage();
}

if(localStorage.getItem("userAccess")==="true"){
enterPage();
}

// ===== UPLOAD =====
fileInput.addEventListener("change",uploadFiles);

async function uploadFiles(filesInput){

const files=filesInput?.target?.files || filesInput;

for(let file of files){

if(!file.type.startsWith("image/")) continue;

const fd=new FormData();
fd.append("file",file);
fd.append("upload_preset","sito-foto");

const res=await fetch(
"https://api.cloudinary.com/v1_1/dwamsmg53/image/upload",
{method:"POST",body:fd}
);

const data=await res.json();

await addDoc(collection(db,"photos"),{
url:data.secure_url,
created:Date.now()
});
}
}

// ===== GALLERY =====
function loadPhotosRealtime(){

const q=query(collection(db,"photos"),orderBy("created","desc"));

onSnapshot(q,snap=>{

gallery.innerHTML="";

snap.forEach(d=>{

const original=d.data().url;

const gridUrl=original.replace(
"/upload/",
"/upload/c_fit,w_500,h_500,q_auto,f_auto/l_text:Arial_80:¬©%20Privato,o_20,a_45,g_center/"
);

const fullUrl=original.replace(
"/upload/",
"/upload/c_limit,w_1600,h_1600,q_auto:best,f_auto/l_text:Arial_80:¬©%20Privato,o_20,a_45,g_center/"
);

const img=gallery.classList.contains("full")?fullUrl:gridUrl;

gallery.innerHTML+=`
<div class="photo">
<img src="${img}" oncontextmenu="return false">
</div>`;
});
});
}

// ===== CHAT =====

const headerHeight=document.querySelector("header").offsetHeight;

const chat=document.createElement("div");
chat.className="chat";
chat.style.top=headerHeight+"px";
chat.style.height=`calc(100vh - ${headerHeight}px)`;

chat.innerHTML=`
<div style="padding:15px;border-bottom:1px solid #23264a;">
<input id="msgInput" placeholder="Scrivi...">
</div>
<div class="messages" id="messages"></div>
`;

document.body.appendChild(chat);

const messagesDiv=document.getElementById("messages");
const msgInput=document.getElementById("msgInput");
const user=isAdmin?"admin":"user";

msgInput.addEventListener("keydown",async e=>{
if(e.key==="Enter"){

const text=msgInput.value.trim();
if(!text) return;

msgInput.value="";

await addDoc(collection(db,"messages"),{
text,user,time:Date.now()
});
}
});

const mq=query(collection(db,"messages"),orderBy("time","desc"));

onSnapshot(mq,snap=>{

messagesDiv.innerHTML="";

snap.forEach(d=>{

const m=d.data();
const name=m.user==="admin"?"Admin":"Ospite";
const align=m.user==="admin"?"right":"left";

const text=m.text.replace(
/(https?:\/\/[^\s]+)/g,
'<a href="$1" target="_blank" style="color:#4ea1ff;">$1</a>'
);

messagesDiv.innerHTML+=`
<div style="margin-bottom:10px;text-align:${align}">
<b>${name}:</b> ${text}
</div>`;
});
});

// ===== DELETE =====
window.deletePage=async()=>{

if(!confirm("Eliminare pagina?")) return;

await deleteDoc(doc(db,"page","config"));

const photos=await getDocs(collection(db,"photos"));
photos.forEach(p=>deleteDoc(p.ref));

const msgs=await getDocs(collection(db,"messages"));
msgs.forEach(m=>deleteDoc(m.ref));

localStorage.clear();
location.reload();
};

// ===== DRAG DROP =====
if(isAdmin){

let overlay=null;

document.addEventListener("dragenter",e=>{
e.preventDefault();

if(!overlay){
overlay=document.createElement("div");
overlay.className="drag-overlay";
overlay.innerText="Rilascia le foto per caricarle";
document.body.appendChild(overlay);
}
});

document.addEventListener("dragover",e=>e.preventDefault());

document.addEventListener("dragleave",e=>{
if(e.clientX===0 && e.clientY===0){
overlay?.remove();
overlay=null;
}
});

document.addEventListener("drop",async e=>{
e.preventDefault();
overlay?.remove();
overlay=null;
uploadFiles(e.dataTransfer.files);
});
}

</script>
</body>
</html>
