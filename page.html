<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="UTF-8">
<title>Pagina privata</title>

<style>

/* ===== RESET ===== */

*{
  box-sizing:border-box;
  font-family:Arial,sans-serif;
}

body{
  margin:0;
  background:#0f1220;
  color:#eaeaf0;
}

/* ===== HEADER ===== */

header{
  background:#15182d;
  padding:20px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #23264a;
  position:sticky;
  top:0;
  z-index:1000;
}

.header-right{
  display:flex;
  gap:10px;
  align-items:center;
}

header button{
  background:#667eea;
  border:none;
  color:white;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

.admin-tools{display:none;}

/* ===== LAYOUT ===== */

.layout{
  display:grid;
  grid-template-columns:1fr;
  padding:20px 40px;
}

/* ===== GALLERY ===== */

.gallery{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:14px;
}

@media(max-width:1400px){.gallery{grid-template-columns:repeat(5,1fr);}}
@media(max-width:1100px){.gallery{grid-template-columns:repeat(4,1fr);}}
@media(max-width:800px){.gallery{grid-template-columns:repeat(3,1fr);}}
@media(max-width:500px){.gallery{grid-template-columns:repeat(2,1fr);}}

/* FOTO */

.photo{
  border-radius:10px;
  overflow:hidden;
  aspect-ratio:1/1;
}

.photo img{
  width:100%;
  height:100%;
  object-fit:contain;
  background:#000;
}

/* ===== FULL VIEW ===== */

.gallery.full{
  grid-template-columns:1fr;
  justify-items:center;
  gap:30px;
}

.gallery.full .photo{
  width:90%;
  max-width:1200px;
  height:80vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#000;
}

/* ===== LOGIN ===== */

.login{
  max-width:400px;
  margin:120px auto;
  background:#15182d;
  padding:40px;
  border-radius:12px;
  text-align:center;
}

.login input{
  width:100%;
  padding:12px;
  margin-bottom:20px;
  border:none;
  border-radius:6px;
}

.login button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:6px;
  background:#667eea;
  color:white;
}

/* ===== CHAT ===== */

.chat{
  position:fixed;
  right:0;
  width:320px;
  background:#15182d;
  border-left:1px solid #23264a;
  display:flex;
  flex-direction:column;
}

.chat-input{
  padding:15px;
  border-bottom:1px solid #23264a;
}

.chat-input input{
  width:100%;
  padding:14px;
  border:none;
  border-radius:8px;
  font-size:15px;
  background:#0f1220;
  color:white;
}

.messages{
  flex:1;
  overflow-y:auto;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.msg{
  max-width:80%;
  padding:10px 14px;
  border-radius:12px;
  font-size:14px;
  word-wrap:break-word;
}

.msg.admin{
  align-self:flex-end;
  background:#667eea;
  color:white;
}

.msg.user{
  align-self:flex-start;
  background:#2a2f55;
  color:#eaeaf0;
}

/* ===== DRAG ===== */

.drag-overlay{
  position:fixed;
  inset:0;
  background:rgba(102,126,234,0.05);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:28px;
  color:white;
  z-index:9999;
}

</style>

</head>
<body>

<header>

<h1>üì∏ Pagina privata</h1>

<div class="header-right">

<button onclick="setGrid()">üß±</button> <button onclick="setFull()">üñºÔ∏è</button>

<div class="admin-tools" id="adminTools">
<button onclick="fileInput.click()">‚ûï Carica foto</button>
<button onclick="deletePage()" style="background:#e53e3e;">üóë Elimina pagina</button>
</div>

</div>
</header>

<div class="login" id="loginBox">
<h2>Accesso riservato</h2>
<input type="password" id="pwd">
<button onclick="checkPassword()">Entra</button>
</div>

<div class="layout" id="content" style="display:none;">
<div class="gallery" id="gallery"></div>
</div>

<input type="file" id="fileInput" multiple hidden>

<script type="module">

// ===== FIREBASE =====
import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getFirestore,doc,getDoc,setDoc,collection,addDoc,
onSnapshot,query,orderBy,deleteDoc,getDocs

}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app=initializeApp({
apiKey:"AIzaSyBcexeHnAQ-ee5q5ZUT_7SqaMS-aSWZdcY",
authDomain:"sito-foto-98234.firebaseapp.com",
projectId:"sito-foto-98234"
});

const db=getFirestore(app);

const gallery=document.getElementById("gallery");
const loginBox=document.getElementById("loginBox");
const content=document.getElementById("content");
const adminTools=document.getElementById("adminTools");
const fileInput=document.getElementById("fileInput");

const isAdmin=localStorage.getItem("admin")==="true";

// ===== LISTENER CONFIG REALTIME =====
onSnapshot(doc(db,"page","config"),snap=>{

if(!snap.exists()){

localStorage.removeItem("userAccess");

if(isAdmin){
location.href="index.html";
}else{
location.href="deleted.html";
}

}

});

// ===== ACCESSO =====
window.addEventListener("load", async ()=>{

const snap =
  await getDoc(doc(db,"page","config"));

// üî¥ Pagina eliminata
if(!snap.exists()){

  if(isAdmin){
    location.href="index.html";
  }else{
    location.href="deleted.html";
  }

  return;
}

// üü¢ ADMIN entra diretto
if(isAdmin){

  loginBox.style.display="none";
  content.style.display="grid";
  adminTools.style.display="flex";

  loadPhotosRealtime();
  startChat();

  return;
}

// üîê UTENTE ‚Üí solo login
loginBox.style.display="block";
content.style.display="none";

});

// ===== LOGIN =====
window.checkPassword=async()=>{

const pwd=document.getElementById("pwd").value;
const snap=await getDoc(doc(db,"page","config"));

if(pwd===snap.data().password){
localStorage.setItem("userAccess","true");
enterPage();
}else alert("Password errata");

};

// ===== ENTER =====
async function enterPage(){

loginBox.style.display="none";
content.style.display="grid";

if(isAdmin)
adminTools.style.display="flex";

loadPhotosRealtime();
startChat();

}

// ===== VIEW =====
window.setGrid=()=>{
gallery.classList.remove("full");
loadPhotosRealtime();
};

window.setFull=()=>{
gallery.classList.add("full");
loadPhotosRealtime();
};

// ===== UPLOAD =====
fileInput.addEventListener("change",e=>uploadFiles(e.target.files));

async function uploadFiles(files){

for(let file of files){

const fd=new FormData();
fd.append("file",file);
fd.append("upload_preset","sito-foto");

const res=await fetch(
"https://api.cloudinary.com/v1_1/dwamsmg53/image/upload",
{method:"POST",body:fd}
);

const data=await res.json();

await addDoc(collection(db,"photos"),{
url:data.secure_url,
created:Date.now()
});
}
}

// ===== GALLERY =====
function loadPhotosRealtime(){

const q=query(collection(db,"photos"),orderBy("created","desc"));

onSnapshot(q,snap=>{

gallery.innerHTML="";

snap.forEach(d=>{

const original=d.data().url;

const gridUrl=original.replace(
"/upload/",
"/upload/c_fit,w_500,h_500,q_auto,f_auto/l_text:Arial_80:¬©%20Privato,o_20,a_45,g_center/"
);

const fullUrl=original.replace(
"/upload/",
"/upload/c_limit,w_1600,h_1600,q_auto:best,f_auto/l_text:Arial_80:¬©%20Privato,o_20,a_45,g_center/"
);

const img=gallery.classList.contains("full")?fullUrl:gridUrl;

gallery.innerHTML+=`
<div class="photo">
<img src="${img}">
</div>`;
});
});
}

// ===== CHAT (PARTE SOLO DOPO LOGIN) =====
function startChat(){

const headerHeight=document.querySelector("header").offsetHeight;

const chat=document.createElement("div");
chat.className="chat";
chat.style.top=headerHeight+"px";
chat.style.height=`calc(100vh - ${headerHeight}px)`;

chat.innerHTML=`

<div class="chat-input">
<input id="msgInput" placeholder="Scrivi un messaggio...">
</div>

<div class="messages" id="messages"></div>

`;

document.body.appendChild(chat);

const messagesDiv=document.getElementById("messages");
const msgInput=document.getElementById("msgInput");
const user=isAdmin?"admin":"user";

msgInput.addEventListener("keydown",async e=>{
if(e.key==="Enter"){

const text=msgInput.value.trim();
if(!text) return;

msgInput.value="";

await addDoc(collection(db,"messages"),{
text,user,time:Date.now()
});
}
});

onSnapshot(
query(collection(db,"messages"),orderBy("time","desc")),
snap=>{

messagesDiv.innerHTML="";

snap.forEach(d=>{

const m=d.data();
const role=m.user==="admin"?"admin":"user";
const name=m.user==="admin"?"Admin":"Ospite";

const text=m.text.replace(
/(https?:\/\/[^\s]+)/g,
'<a href="$1" target="_blank" style="color:#4ea1ff;">$1</a>'
);

messagesDiv.innerHTML+=`
<div class="msg ${role}">
<b>${name}:</b><br>${text}
</div>`;
});
});
}

// ===== DELETE PAGE COMPLETO =====
window.deletePage = async ()=>{

  if(!confirm("Eliminare pagina e TUTTI i dati?"))
    return;

  // 1Ô∏è‚É£ Cancella CONFIG
  await deleteDoc(doc(db,"page","config"));

  // 2Ô∏è‚É£ Cancella FOTO
  const photosSnap =
    await getDocs(collection(db,"photos"));

  for(const p of photosSnap.docs){
    await deleteDoc(p.ref);
  }

  // 3Ô∏è‚É£ Cancella CHAT
  const msgSnap =
    await getDocs(collection(db,"messages"));

  for(const m of msgSnap.docs){
    await deleteDoc(m.ref);
  }

  // 4Ô∏è‚É£ Reset accessi
  localStorage.removeItem("userAccess");

  // 5Ô∏è‚É£ Redirect diversi
  if(isAdmin){

    // Admin torna a creare nuova pagina
    location.href="admin.html";

  }else{

    // Utente pagina eliminata
    location.href="deleted.html";

  }

};

// ===== DRAG =====
if(isAdmin){

let overlay=null;

document.addEventListener("dragenter",e=>{
e.preventDefault();
if(!overlay){
overlay=document.createElement("div");
overlay.className="drag-overlay";
overlay.innerText="Rilascia le foto per caricarle";
document.body.appendChild(overlay);
}
});

document.addEventListener("dragover",e=>e.preventDefault());

document.addEventListener("drop",e=>{
e.preventDefault();
overlay?.remove();
uploadFiles(e.dataTransfer.files);
});
}

</script>

</body>
</html>
