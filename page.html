<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Pagina privata</title>

<style>
body {
  margin:0;
  background:#0f1220;
  color:white;
  font-family:Arial;
}

header {
  background:#15182d;
  padding:20px 40px;
}

.gallery {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:20px;
  padding:20px 40px;
}

.photo img {
  width:100%;
  border-radius:10px;
}
</style>
</head>
<body>

<header>
<h1>ðŸ“¸ Pagina privata</h1>
<button id="uploadBtn" style="display:none;">Carica foto</button>
</header>

<div id="loginBox" style="padding:40px;">
<input id="pwd" placeholder="Password">
<button onclick="checkPassword()">Entra</button>
</div>

<div class="gallery" id="gallery" style="display:none;"></div>

<input type="file" id="fileInput" hidden multiple>

<script type="module">

// ===== FIREBASE IMPORT UNICO =====
import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getFirestore,
  doc,
  getDoc,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ===== CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyBcexeHnAQ-ee5q5ZUT_7SqaMS-aSWZdcY",
  authDomain: "sito-foto-98234.firebaseapp.com",
  projectId: "sito-foto-98234",
  storageBucket: "sito-foto-98234.firebasestorage.app",
  messagingSenderId: "1014303170766",
  appId: "1:1014303170766:web:1a96871b022c7401ef309f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== ELEMENTI =====
const gallery = document.getElementById("gallery");
const loginBox = document.getElementById("loginBox");
const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("fileInput");

const isAdmin = localStorage.getItem("admin") === "true";

// ===== LOGIN PASSWORD =====
window.checkPassword = async function() {

  const pwd = document.getElementById("pwd").value;

  const snap = await getDoc(doc(db,"page","config"));

  if (pwd === snap.data().password) {
    enterPage();
  } else {
    alert("Password errata");
  }
};

// ===== ENTRA =====
function enterPage() {

  loginBox.style.display="none";
  gallery.style.display="grid";

  if (isAdmin) uploadBtn.style.display="block";

  loadPhotos();
}

// ===== ADMIN AUTO =====
if (isAdmin) enterPage();

// ===== UPLOAD =====
uploadBtn.onclick=()=>fileInput.click();

fileInput.addEventListener("change", async()=>{

  for (let file of fileInput.files){

    const fd=new FormData();
    fd.append("file",file);
    fd.append("upload_preset","sito-foto");

    const res=await fetch(
      "https://api.cloudinary.com/v1_1/dwamsmg53/image/upload",
      {method:"POST",body:fd}
    );

    const data=await res.json();

    await addDoc(collection(db,"photos"),{
      url:data.secure_url,
      created:Date.now()
    });
  }
});

// ===== GALLERY REALTIME =====
function loadPhotos(){

  const q=query(
    collection(db,"photos"),
    orderBy("created")
  );

  onSnapshot(q,snap=>{

    gallery.innerHTML="";

    snap.forEach(d=>{
      gallery.innerHTML+=
        `<div class="photo">
           <img src="${d.data().url}">
         </div>`;
    });
  });
}

</script>

</body>
</html>
