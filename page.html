<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Pagina privata</title>

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }

body {
  margin: 0;
  background: #0f1220;
  color: #eaeaf0;
  min-height: 100vh;
}

header {
  background: #15182d;
  padding: 20px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #23264a;
}

.admin-tools { display: none; gap: 12px; }
.admin-tools button {
  background: #667eea;
  border: none;
  color: white;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
}

.layout {
  display: grid;
  grid-template-columns: 1fr 260px;
  gap: 20px;
  padding: 20px 40px;
}

.gallery {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
}

.photo {
  background: #1c2040;
  border-radius: 10px;
  aspect-ratio: 1/1;
  overflow: hidden;
}

.photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.login {
  max-width: 400px;
  margin: 120px auto;
  background: #15182d;
  padding: 40px;
  border-radius: 12px;
  text-align: center;
}
</style>
</head>
<body>

<header>
<h1>ðŸ“¸ Pagina privata</h1>
<div class="admin-tools" id="adminTools">
<button onclick="fileInput.click()">âž• Carica foto</button>
</div>
</header>

<div class="login" id="loginBox">
<h2>Accesso riservato</h2>
<input type="password" id="pwd" placeholder="Password">
<button onclick="checkPassword()">Entra</button>
</div>

<div class="layout" id="content" style="display:none;">
<div class="gallery" id="gallery"></div>
</div>

<input type="file" id="fileInput" multiple accept="image/*" hidden>

<!-- ================= SCRIPT ================= -->
<script type="module">

// ðŸ”¥ FIREBASE IMPORT
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  collection,
  addDoc,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ðŸ”§ CONFIG TUA
const firebaseConfig = {
  apiKey: "AIzaSyBcexeHnAQ-ee5q5ZUT_7SqaMS-aSWZdcY",
  authDomain: "sito-foto-98234.firebaseapp.com",
  projectId: "sito-foto-98234",
  storageBucket: "sito-foto-98234.firebasestorage.app",
  messagingSenderId: "1014303170766",
  appId: "1:1014303170766:web:1a96871b022c7401ef309f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ================= ELEMENTI =================
const gallery = document.getElementById("gallery");
const loginBox = document.getElementById("loginBox");
const content = document.getElementById("content");
const adminTools = document.getElementById("adminTools");
const fileInput = document.getElementById("fileInput");

const isAdmin = localStorage.getItem("admin") === "true";

// ================= LOGIN PASSWORD =================
window.checkPassword = async function () {

  const pwd = document.getElementById("pwd").value;

  const snap = await getDoc(doc(db, "page", "config"));

  if (!snap.exists()) {
    alert("Pagina non attiva");
    return;
  }

  const data = snap.data();

  if (pwd === data.password) {
    enterPage();
  } else {
    alert("Password errata");
  }
};

// ================= ENTRA =================
function enterPage() {
  loginBox.style.display = "none";
  content.style.display = "grid";
  loadPhotosRealtime();

}

// ================= ADMIN =================
if (isAdmin) {
  adminTools.style.display = "flex";
  enterPage();
}

// ================= UPLOAD FOTO =================
fileInput.addEventListener("change", async () => {

  const files = fileInput.files;

  for (let file of files) {

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "sito-foto");

    const res = await fetch(
      "https://api.cloudinary.com/v1_1/dwamsmg53/image/upload",
      {
        method: "POST",
        body: formData
      }
    );

    const data = await res.json();

    // ðŸ’¾ SALVA URL SU FIREBASE
    await addDoc(collection(db, "photos"), {
      url: data.secure_url,
      created: Date.now()
    });
  }

  loadPhotosRealtime();

});

// ================= LOAD GALLERY =================
import {
  onSnapshot,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// REALTIME GALLERY
function loadPhotosRealtime() {

  const q = query(
    collection(db, "photos"),
    orderBy("created")
  );

  onSnapshot(q, snap => {

    gallery.innerHTML = "";

    snap.forEach(doc => {

      const div = document.createElement("div");
      div.className = "photo";

      div.innerHTML =
        `<img src="${doc.data().url}">`;

      gallery.appendChild(div);
    });
  });
}

// ================= CHAT FULL HEIGHT =================

import {
  onSnapshot,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// CREA CONTENITORE CHAT
const chatBox = document.createElement("div");

chatBox.style.position = "fixed";
chatBox.style.right = "0";
chatBox.style.top = "80px";
chatBox.style.width = "300px";
chatBox.style.height = "calc(100vh - 80px)";
chatBox.style.background = "#15182d";
chatBox.style.display = "flex";
chatBox.style.flexDirection = "column";
chatBox.style.borderLeft = "1px solid #23264a";

// HTML CHAT
chatBox.innerHTML = `

  <div style="
    padding:15px;
    border-bottom:1px solid #23264a;
  ">
    <input
      id="msgInput"
      placeholder="Scrivi messaggio..."
      style="
        width:100%;
        padding:10px;
        border-radius:6px;
        border:none;
        font-size:14px;
      ">
  </div>

  <div id="messages"
       style="
         flex:1;
         overflow-y:auto;
         padding:15px;
       ">
  </div>
`;

document.body.appendChild(chatBox);

const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");

const user = isAdmin ? "admin" : "user";

// ================= INVIO =================
msgInput.addEventListener("keydown", async e => {

  if (e.key === "Enter") {

    const text = msgInput.value.trim();
    if (!text) return;

    msgInput.value = "";

    await addDoc(collection(db, "messages"), {
      text,
      user,
      time: Date.now()
    });
  }
});

// ================= RICEZIONE REALTIME =================
const q = query(
  collection(db, "messages"),
  orderBy("time")
);

onSnapshot(q, snap => {

  messagesDiv.innerHTML = "";

  snap.forEach(doc => {

    const m = doc.data();

    const name =
      m.user === "admin"
        ? "Admin"
        : "Ospite";

    const align =
      m.user === "admin"
        ? "right"
        : "left";

    messagesDiv.innerHTML += `
      <div style="
        margin-bottom:10px;
        text-align:${align};
      ">
        <b>${name}:</b> ${m.text}
      </div>
    `;
  });

  messagesDiv.scrollTop =
    messagesDiv.scrollHeight;
});


</script>

</body>
</html>
